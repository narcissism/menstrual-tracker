<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Period Tracker with Moon History</title>
<style>
body { font-family:sans-serif; margin:0; background:#fff; display:flex; flex-direction:column; align-items:center; }
#controls { margin-top:10px; }
button { margin:0 5px; }
#calendar { display:grid; grid-template-columns: repeat(7, 60px); gap:5px; margin-top:20px; }
.day { width:60px; height:60px; border:1px solid #ccc; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; position:relative; font-size:12px; }
.day.period { background:#fdd; }
.day.ovulation { background:#ffd; }
.day span.moon { position:absolute; bottom:2px; font-size:14px; }
.weekdays { display:grid; grid-template-columns:repeat(7, 60px); gap:5px; margin-top:10px; font-weight:bold; text-align:center; }
#modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border:1px solid #333; padding:20px; z-index:10; }
#modal select { margin-bottom:10px; width:100%; }
#analysis { margin-top:20px; width:80%; }
</style>
</head>
<body>

<h1>Period Tracker</h1>

<div id="controls">
  <button id="prevMonth">â—€ Previous</button>
  <span id="monthLabel"></span>
  <button id="nextMonth">Next â–¶</button>
</div>

<div class="weekdays">
  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
</div>

<div id="calendar"></div>

<div id="modal">
  <h3>Track Day</h3>
  <label>Period: <input type="checkbox" id="periodCheck"></label><br>
  <label>Mood:
    <select id="moodSelect">
      <option value="">--</option>
      <option value="Happy">Happy</option>
      <option value="Irritable">Irritable</option>
      <option value="Sad">Sad</option>
      <option value="Anxious">Anxious</option>
    </select>
  </label><br>
  <label>Symptoms:
    <select id="symptomSelect" multiple size=4>
      <option value="Cramps">Cramps</option>
      <option value="Bloating">Bloating</option>
      <option value="Headache">Headache</option>
      <option value="Fatigue">Fatigue</option>
    </select>
  </label><br>
  <button id="saveBtn">Save</button>
  <button id="closeBtn">Close</button>
</div>

<div id="analysis">
  <h2>Analysis</h2>
  <div id="cycleLength"></div>
  <div id="periodLength"></div>
  <div id="symptomTrends"></div>
  <div id="phaseInfo"></div>
</div>

<script>
// DATA
let entries = {}; 
const calendar = document.getElementById('calendar');
let selectedDate = null;

// CURRENT VIEW
let viewYear = 2026;
let viewMonth = 0; // January 2026

// WEEKDAY HEADERS already in HTML

// MOON PHASES
// Realigned moon calculation using reference full moon: Jan 6, 2026
const referenceFullMoon = new Date("2026-01-06T00:00:00Z").getTime();
const lunarCycle = 29.53058867; // days

function moonIcon(date){
  const d = new Date(date).getTime();
  const diffDays = (d - referenceFullMoon) / (1000*60*60*24);
  let phase = (diffDays / lunarCycle) % 1;
  if(phase <0) phase +=1; // wrap negative
  if(phase < 0.03 || phase >0.97) return 'ðŸŒ‘';
  if(phase < 0.22) return 'ðŸŒ’';
  if(phase < 0.28) return 'ðŸŒ“';
  if(phase < 0.47) return 'ðŸŒ”';
  if(phase < 0.53) return 'ðŸŒ•';
  if(phase < 0.72) return 'ðŸŒ–';
  if(phase < 0.78) return 'ðŸŒ—';
  return 'ðŸŒ˜';
}

// CALENDAR BUILD
function buildCalendar(){
  document.getElementById('monthLabel').innerText = new Date(viewYear, viewMonth).toLocaleString('default',{month:'long', year:'numeric'});
  calendar.innerHTML='';
  const firstDay = new Date(viewYear, viewMonth,1);
  const lastDay = new Date(viewYear, viewMonth+1,0);
  const startDay = firstDay.getDay();
  // empty divs before first day
  for(let i=0;i<startDay;i++) calendar.appendChild(document.createElement('div'));
  // days
  for(let d=1; d<=lastDay.getDate(); d++){
    const date = new Date(viewYear, viewMonth,d);
    const key = date.toISOString().split('T')[0];
    const div = document.createElement('div');
    div.className='day';
    div.dataset.date=key;
    div.innerHTML = `<span>${d}</span><span class="moon">${moonIcon(date)}</span>`;
    if(entries[key]){
      if(entries[key].period) div.classList.add('period');
      else if(entries[key].phase==='ovulation') div.classList.add('ovulation');
    }
    div.onclick = ()=>openModal(key);
    calendar.appendChild(div);
  }
}

// NAVIGATION
document.getElementById('prevMonth').onclick = ()=>{
  viewMonth--;
  if(viewMonth<0){ viewMonth=11; viewYear--; }
  buildCalendar();
}
document.getElementById('nextMonth').onclick = ()=>{
  viewMonth++;
  if(viewMonth>11){ viewMonth=0; viewYear++; }
  buildCalendar();
}

// MODAL
const modal = document.getElementById('modal');
const periodCheck = document.getElementById('periodCheck');
const moodSelect = document.getElementById('moodSelect');
const symptomSelect = document.getElementById('symptomSelect');
document.getElementById('saveBtn').onclick = ()=>{
  entries[selectedDate]={
    period: periodCheck.checked,
    mood: moodSelect.value,
    symptoms: Array.from(symptomSelect.selectedOptions).map(o=>o.value)
  };
  modal.style.display='none';
  assignPhases();
  buildCalendar();
  updateAnalysis();
};
document.getElementById('closeBtn').onclick = ()=>{ modal.style.display='none'; }
function openModal(date){
  selectedDate=date;
  const entry = entries[date] || {period:false, mood:'', symptoms:[]};
  periodCheck.checked = entry.period;
  moodSelect.value = entry.mood;
  Array.from(symptomSelect.options).forEach(o=>o.selected=entry.symptoms.includes(o.value));
  modal.style.display='block';
}

// ANALYSIS
function updateAnalysis(){
  const keys = Object.keys(entries).sort();
  const periodStarts = keys.filter(k=>entries[k].period).map(k=>new Date(k));
  let cycles=[];
  for(let i=1;i<periodStarts.length;i++){
    cycles.push(Math.round((periodStarts[i]-periodStarts[i-1])/(1000*60*60*24)));
  }
  document.getElementById('cycleLength').innerText = cycles.length>0 ? `Average cycle length: ${Math.round(cycles.reduce((a,b)=>a+b,0)/cycles.length)} days` : 'Average cycle length: N/A';
  // period length
  let lengths=[];
  for(let i=0;i<periodStarts.length;i++){
    let start=periodStarts[i], count=1;
    for(let j=1;j<keys.length;j++){
      const next=new Date(keys[j]);
      if(next>start && entries[keys[j]]?.period) count++;
      else break;
    }
    lengths.push(count);
  }
  document.getElementById('periodLength').innerText = lengths.length>0 ? `Average period length: ${Math.round(lengths.reduce((a,b)=>a+b,0)/lengths.length)} days` : 'Average period length: N/A';
  // symptoms
  const symptomCounts={};
  for(let k of keys){
    if(entries[k]?.symptoms) entries[k].symptoms.forEach(s=>{
      symptomCounts[s]=(symptomCounts[s]||0)+1;
    });
  }
  document.getElementById('symptomTrends').innerText = 'Symptom frequency: '+Object.entries(symptomCounts).map(([s,c])=>`${s}: ${c}`).join(', ');
  const phases=['Menstrual','Follicular','Ovulation','Luteal'];
  document.getElementById('phaseInfo').innerText = 'Phase info: '+phases.join(', ');
}

// CYCLE PHASE ASSIGNMENT
function assignPhases(){
  const keys=Object.keys(entries).sort();
  const periodStarts=keys.filter(k=>entries[k].period).map(k=>new Date(k));
  if(periodStarts.length<2) return;
  const cycleLength = Math.round((periodStarts[1]-periodStarts[0])/(1000*60*60*24));
  for(let i=0;i<keys.length;i++){
    const d=new Date(keys[i]);
    const daysSinceStart=Math.round((d-periodStarts[0])/(1000*60*60*24));
    if(entries[keys[i]].period) entries[keys[i]].phase='Menstrual';
    else if(daysSinceStart>=cycleLength*0.5-1 && daysSinceStart<=cycleLength*0.5+1) entries[keys[i]].phase='Ovulation';
    else if(daysSinceStart<cycleLength*0.5) entries[keys[i]].phase='Follicular';
    else entries[keys[i]].phase='Luteal';
  }
}

// INIT
buildCalendar();
updateAnalysis();
</script>
</body>
</html>
